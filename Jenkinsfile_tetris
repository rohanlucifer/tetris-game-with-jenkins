pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
    }

    environment {
        KUBECONFIG = credentials('kubeconfig')
    }

    stages {

        stage('Clone Repository') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'github-secret',
                        usernameVariable: 'GIT_USER',
                        passwordVariable: 'GIT_TOKEN'
                    )
                ]) {
                    sh '''
                    rm -rf tetris-game-with-jenkins
                    git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/rohanlucifer/tetris-game-with-jenkins.git
                    '''
                }
            }
        }

        stage('Verify Cluster Access') {
            steps {
                sh '''
                kubectl get nodes
                '''
            }
        }

        stage('Deploy Tetris Application') {
            steps {
                dir('tetris-game-with-jenkins') {
                    sh '''
                    kubectl apply -f deploy.yaml
                    kubectl wait --for=condition=Ready pod -l app=tetris --timeout=120s
                    kubectl get pods
                    '''
                }
            }
        }

        stage('Install MetalLB') {
            steps {
                dir('tetris-game-with-jenkins') {
                    sh '''
                    kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.5/config/manifests/metallb-native.yaml
                    kubectl wait --for=condition=Ready pod -n metallb-system -l app=metallb --timeout=120s
                    kubectl apply -f metallb.yaml
                    kubectl get pods -n metallb-system
                    '''
                }
            }
        }

        stage('Apply Ingress') {
            steps {
                dir('tetris-game-with-jenkins') {
                    sh '''
                    kubectl apply -f ingress.yaml
                    kubectl get ingress
                    '''
                }
            }
        }
    }
}
