pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
    }

    environment {
        KUBECONFIG = credentials('kubeconfig')
    }

    stages {

        stage('Clone Repository') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'github-secret',
                        usernameVariable: 'GIT_USER',
                        passwordVariable: 'GIT_TOKEN'
                    )
                ]) {
                    sh '''
                    rm -rf tetris-game-with-jenkins
                    git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/rohanlucifer/tetris-game-with-jenkins.git
                    '''
                }
            }
        }

        stage('Verify Kubernetes Access') {
            steps {
                sh '''
                kubectl get nodes
                kubectl cluster-info
                '''
            }
        }

        stage('Install Ingress-NGINX Controller') {
            steps {
                sh '''
                kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.1/deploy/static/provider/cloud/deploy.yaml

                kubectl wait -n ingress-nginx \
                  --for=condition=Ready pod \
                  -l app.kubernetes.io/component=controller \
                  --timeout=180s
                '''
            }
        }

        stage('Install MetalLB') {
            steps {
                sh '''
                kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.5/config/manifests/metallb-native.yaml

                kubectl wait -n metallb-system \
                  --for=condition=Ready pod \
                  -l app=metallb \
                  --timeout=180s
                '''
            }
        }

        stage('Configure MetalLB IP Pool') {
            steps {
                dir('tetris-game-with-jenkins') {
                    sh '''
                    kubectl apply -f metallb.yaml
                    kubectl get ipaddresspool -n metallb-system
                    '''
                }
            }
        }

        stage('Deploy Tetris Application') {
            steps {
                dir('tetris-game-with-jenkins') {
                    sh '''
                    kubectl apply -f deploy.yaml

                    kubectl wait \
                      --for=condition=Ready pod \
                      -l app=tetris \
                      --timeout=180s

                    kubectl get pods
                    kubectl get svc
                    '''
                }
            }
        }

        stage('Apply Ingress') {
            steps {
                dir('tetris-game-with-jenkins') {
                    sh '''
                    kubectl apply -f ingress.yaml
                    kubectl get ingress
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment completed successfully'
        }
        failure {
            echo 'Deployment failed â€“ check logs'
        }
    }
}
